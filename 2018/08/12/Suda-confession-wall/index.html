<!DOCTYPE html><html class="theme-next pisces use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css"><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="Suda,"><meta name="description" content="我...我在干啥...我为啥要听信他们来做这个啊"><meta name="keywords" content="Suda"><meta property="og:type" content="article"><meta property="og:title" content="记一次suda框架之表白墙"><meta property="og:url" content="http://yoursite.com/2018/08/12/Suda-confession-wall/index.html"><meta property="og:site_name" content="MoBenw"><meta property="og:description" content="我...我在干啥...我为啥要听信他们来做这个啊"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http://yoursite.com/2018/08/12/Suda-confession-wall/2018/08/12/Suda-confession-wall/0.png"><meta property="og:updated_time" content="2018-09-09T13:31:33.377Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="记一次suda框架之表白墙"><meta name="twitter:description" content="我...我在干啥...我为啥要听信他们来做这个啊"><meta name="twitter:image" content="http://yoursite.com/2018/08/12/Suda-confession-wall/2018/08/12/Suda-confession-wall/0.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Pisces",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!0,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"0WGKTU8P2U",apiKey:"3a7db1e65976d82c8bb18e2853de726e",indexName:"mobenw",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://yoursite.com/2018/08/12/Suda-confession-wall/"><title>记一次suda框架之表白墙 | MoBenw</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b8b7d27fcb70fd3039db26232cdc20c3";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div> <a href="https://github.com/MoBenw" class="github-corner" aria-label="View source on Github"><svg width="120" height="120" viewBox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">MoBenw</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="algolia-popup popup search-popup"><div class="algolia-search"><div class="algolia-search-input-icon"><i class="fa fa-search"></i></div><div class="algolia-search-input" id="algolia-search-input"></div></div><div class="algolia-results"><div id="algolia-stats"></div><div id="algolia-hits"></div><div id="algolia-pagination" class="algolia-pagination"></div></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/12/Suda-confession-wall/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="MoBenw"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="MoBenw"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">记一次suda框架之表白墙</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-12T22:47:37+08:00">2018-08-12</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Suda框架学习/" itemprop="url" rel="index"><span itemprop="name">Suda框架学习</span></a></span></span> <span class="post-meta-divider">|</span><span class="page-pv"><i class="fa fa-eye"></i> Visitors<span class="busuanzi-value" id="busuanzi_value_page_pv"></span></span><div class="post-wordcount"> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">4,044</span></div><div class="post-description"> 我...我在干啥...我为啥要听信他们来做这个啊</div></div></header><div class="post-body" itemprop="articleBody"><div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery"><div class="post-gallery-row"> <a class="post-gallery-img fancybox" href="/2018/08/12/Suda-confession-wall/0.png" rel="gallery_cjngd39k0001u18r8lxe8pw76" itemscope itemtype="http://schema.org/ImageObject" itemprop="url"><img src="/2018/08/12/Suda-confession-wall/0.png" itemprop="contentUrl"></a></div></div><p>表白墙设计…大概需要这些功能吧</p><ul><li>发布表白</li><li>列出表白</li><li>表白管理<ul><li>增删改查</li></ul></li><li>评论功能</li><li>附件功能</li></ul><h3 id="所需模块"><a href="#所需模块" class="headerlink" title="所需模块"></a>所需模块</h3><ul><li>support</li><li>user</li><li>content-parser</li></ul><h3 id="安装模块"><a href="#安装模块" class="headerlink" title="安装模块"></a>安装模块</h3><ol><li><p>预览一下<br><img src="/2018/08/12/Suda-confession-wall/1.png" alt="1"></p></li><li><p><code>app/mainifast.yml</code> 原 <code>app/mainifast.json</code></p><blockquote><ol><li>为你的app改个好听的name</li><li>配置好启动的模块</li><li>使用<code>.yml</code>文件时需要将下载的<code>vendor</code> 添加至<code>app</code>中</li></ol></blockquote></li></ol><p><img src="/2018/08/12/Suda-confession-wall/2.png" alt="2"></p><ol start="3"><li><code>config.json</code> 可以考虑修改一下数据库<br><img src="/2018/08/12/Suda-confession-wall/3.png" alt="3"></li></ol><ol start="4"><li><p><code>modules</code> 把你的<code>share</code>和<code>import</code>弄好<br><img src="/2018/08/12/Suda-confession-wall/4.png" alt="4"></p></li><li><p><code>router.json</code><br><img src="/2018/08/12/Suda-confession-wall/5.png" alt="5"></p></li></ol><h3 id="基本配置-amp-amp-发布表白"><a href="#基本配置-amp-amp-发布表白" class="headerlink" title="基本配置&amp;&amp;发布表白"></a>基本配置&amp;&amp;发布表白</h3><h4 id="table"><a href="#table" class="headerlink" title="table"></a>table</h4><h5 id="ConfessionTable-php"><a href="#ConfessionTable-php" class="headerlink" title="ConfessionTable.php"></a>ConfessionTable.php</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">dxkite</span>\<span class="title">confession</span>\<span class="title">wall</span>\<span class="title">table</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 表对象，处理表白</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConfessionTable</span> <span class="keyword">extends</span> \<span class="title">suda</span>\<span class="title">archive</span>\<span class="title">Table</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> CONTENT_TYPE = <span class="string">'markdown'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> STATUS_DELETE = <span class="number">0</span>;  <span class="comment">// 删除状态</span></span><br><span class="line">    <span class="keyword">const</span> STATUS_NORMAL = <span class="number">1</span>;  <span class="comment">// 正常状态</span></span><br><span class="line">    <span class="keyword">const</span> STATUS_DRAFT = <span class="number">2</span>;  <span class="comment">// 草稿状态</span></span><br><span class="line">    <span class="keyword">const</span> ANONYMOUS = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">parent</span>::__construct(<span class="string">'confession'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onBuildCreator</span><span class="params">($table)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $table-&gt;fields(</span><br><span class="line">            $table-&gt;field(<span class="string">'id'</span>, <span class="string">'bigint'</span>, <span class="number">20</span>)-&gt;primary()-&gt;unsigned()-&gt;auto(),</span><br><span class="line">            $table-&gt;field(<span class="string">'user'</span>, <span class="string">'bigint'</span>, <span class="number">20</span>)-&gt;key()-&gt;comment(<span class="string">'发布者'</span>),</span><br><span class="line">            $table-&gt;field(<span class="string">'anonymous'</span>, <span class="string">'tinyint'</span>, <span class="number">1</span>)-&gt;default(<span class="keyword">self</span>::ANONYMOUS)-&gt;comment(<span class="string">'匿名发布'</span>),</span><br><span class="line">            $table-&gt;field(<span class="string">'title'</span>, <span class="string">'varchar'</span>, <span class="number">255</span>)-&gt;comment(<span class="string">'标题'</span>),</span><br><span class="line">            $table-&gt;field(<span class="string">'content'</span>, <span class="string">'text'</span>)-&gt;comment(<span class="string">"文字内容"</span>),</span><br><span class="line">            $table-&gt;field(<span class="string">'time'</span>, <span class="string">'int'</span>, <span class="number">11</span>)-&gt;key()-&gt;unsigned()-&gt;comment(<span class="string">'发表时间'</span>),</span><br><span class="line">            $table-&gt;field(<span class="string">'ip'</span>, <span class="string">'varchar'</span>, <span class="number">32</span>)-&gt;comment(<span class="string">'发布IP'</span>),</span><br><span class="line">            $table-&gt;field(<span class="string">'status'</span>, <span class="string">'int'</span>, <span class="number">11</span>)-&gt;key()-&gt;unsigned()-&gt;default(<span class="keyword">self</span>::STATUS_DRAFT)-&gt;comment(<span class="string">'状态'</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用Markdown 对内容进行默认编码</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $content</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">_inputContentField</span><span class="params">(string $content)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> content_pack($content, <span class="keyword">self</span>::CONTENT_TYPE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将内容解码成HTML格式</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $content</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">_outputContentField</span><span class="params">(string $content)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 解码成对象</span></span><br><span class="line">        <span class="keyword">if</span> ($object = content_unpack($content)) &#123;</span><br><span class="line">            <span class="keyword">return</span> $object;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 未设置解码则按text编码</span></span><br><span class="line">        <span class="keyword">return</span> content_create($content, <span class="string">'text'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h4><h5 id="ConfessionController-php"><a href="#ConfessionController-php" class="headerlink" title="ConfessionController.php"></a>ConfessionController.php</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">dxkite</span>\<span class="title">confession</span>\<span class="title">wall</span>\<span class="title">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">dxkite</span>\<span class="title">confession</span>\<span class="title">wall</span>\<span class="title">table</span>\<span class="title">ConfessionTable</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理表白</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConfessionController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $table;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;table = <span class="keyword">new</span> ConfessionTable;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">(string $title, string $content, bool $anonymous=true)</span>: <span class="title">int</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;table-&gt;insert([</span><br><span class="line">            <span class="string">'user'</span> =&gt; get_user_id(),</span><br><span class="line">            <span class="string">'title'</span> =&gt; $title ,</span><br><span class="line">            <span class="string">'content'</span> =&gt; $content,</span><br><span class="line">            <span class="string">'anonymous'</span> =&gt; $anonymous ? <span class="number">1</span> :<span class="number">0</span>,</span><br><span class="line">            <span class="string">'time'</span> =&gt; time(),</span><br><span class="line">            <span class="string">'ip'</span> =&gt; request()-&gt;ip(),</span><br><span class="line">            <span class="string">'status'</span> =&gt; ConfessionTable::STATUS_NORMAL,</span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="provider"><a href="#provider" class="headerlink" title="provider"></a>provider</h4><h5 id="ConfessionProvider-php"><a href="#ConfessionProvider-php" class="headerlink" title="ConfessionProvider.php"></a>ConfessionProvider.php</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">dxkite</span>\<span class="title">confession</span>\<span class="title">wall</span>\<span class="title">provider</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">dxkite</span>\<span class="title">confession</span>\<span class="title">wall</span>\<span class="title">controller</span>\<span class="title">ConfessionController</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理表白</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConfessionProvider</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $controller;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;controller = <span class="keyword">new</span> ConfessionController;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">(string $title, string $content, bool $anonymous=true)</span>: <span class="title">int</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;controller-&gt;add($title,$content,$anonymous);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="src"><a href="#src" class="headerlink" title="src"></a>src</h4><h5 id="IndexResponse-php"><a href="#IndexResponse-php" class="headerlink" title="IndexResponse.php"></a>IndexResponse.php</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">dxkite</span>\<span class="title">confession</span>\<span class="title">wall</span>\<span class="title">response</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">dxkite</span>\<span class="title">support</span>\<span class="title">visitor</span>\<span class="title">response</span>\<span class="title">Response</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">dxkite</span>\<span class="title">support</span>\<span class="title">visitor</span>\<span class="title">Context</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexResponse</span> <span class="keyword">extends</span> <span class="title">Response</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onVisit</span><span class="params">(Context $context)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $view = <span class="keyword">$this</span>-&gt;view(<span class="string">'index'</span>);</span><br><span class="line">        $view-&gt;render();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="PostResponse-php"><a href="#PostResponse-php" class="headerlink" title="PostResponse.php"></a>PostResponse.php</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">dxkite</span>\<span class="title">confession</span>\<span class="title">wall</span>\<span class="title">response</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">dxkite</span>\<span class="title">support</span>\<span class="title">visitor</span>\<span class="title">response</span>\<span class="title">VisitorResponse</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">dxkite</span>\<span class="title">support</span>\<span class="title">visitor</span>\<span class="title">Context</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">dxkite</span>\<span class="title">confession</span>\<span class="title">wall</span>\<span class="title">controller</span>\<span class="title">ConfessionController</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostResponse</span> <span class="keyword">extends</span> <span class="title">VisitorResponse</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onUserVisit</span><span class="params">(Context $context)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $view = <span class="keyword">$this</span>-&gt;view(<span class="string">'post'</span>);</span><br><span class="line">        <span class="keyword">if</span> (request()-&gt;hasPost()) &#123;</span><br><span class="line">            $controller = <span class="keyword">new</span> ConfessionController;</span><br><span class="line">            $title = request()-&gt;post(<span class="string">'title'</span>);</span><br><span class="line">            $context =  request()-&gt;post(<span class="string">'content'</span>);</span><br><span class="line">            $anonymous = request()-&gt;post(<span class="string">'anonymous'</span>,<span class="keyword">false</span>) == <span class="keyword">true</span> ?<span class="keyword">true</span>:<span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> ($title &amp;&amp; $context) &#123;</span><br><span class="line">                $id = $controller-&gt;add($title,$context,$anonymous);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        $view-&gt;render();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="template"><a href="#template" class="headerlink" title="template"></a>template</h4><h5 id="index-tpl-html"><a href="#index-tpl-html" class="headerlink" title="index.tpl.html"></a>index.tpl.html</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@extend ('layout')</span><br><span class="line"><span class="comment">&lt;!-- 插入内容 --&gt;</span></span><br><span class="line">@startInsert('confession-content')</span><br><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>这里是内容<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">@endInsert</span><br></pre></td></tr></table></figure><h5 id="header-tpl-html"><a href="#header-tpl-html" class="headerlink" title="header.tpl.html"></a>header.tpl.html</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">nav</span> <span class="attr">class</span>=<span class="string">"navbar navbar-dark sticky-top bg-dark navbar-expand-lg flex-md-nowrap p-0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"navbar-brand col-sm-3 col-md-2 mr-0"</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>&#123;&#123; $:website_name('涉外学院 - 表白墙') &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"navbar-nav mr-auto"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"navbar-nav px-3"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"nav-item text-nowrap"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"nav-link @b($this-&gt;isMe('index'),'active')"</span> <span class="attr">href</span>=<span class="string">"@u('index')"</span>&gt;</span>首页<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="layout-tpl-html"><a href="#layout-tpl-html" class="headerlink" title="layout.tpl.html"></a>layout.tpl.html</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@extend ('support:bootstrap') </span><br><span class="line">@startInsert('bs-head')</span><br><span class="line"><span class="comment">&lt;!-- css --&gt;</span></span><br><span class="line">@endInsert </span><br><span class="line">@startInsert('bs-content') </span><br><span class="line">@include ('header')</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">    @if ($?:alert)</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"alert alert-&#123;&#123; $:alert.type &#125;&#125; m-2"</span> <span class="attr">role</span>=<span class="string">"alert"</span>&gt;</span> &#123;&#123; $:alert.text &#125;&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"close"</span> <span class="attr">data-dismiss</span>=<span class="string">"alert"</span> <span class="attr">aria-label</span>=<span class="string">"Close"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span>&amp;times;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    @endif </span><br><span class="line">    @insert('confession-content')</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">@endInsert</span><br></pre></td></tr></table></figure><h5 id="post-tpl-html"><a href="#post-tpl-html" class="headerlink" title="post.tpl.html"></a>post.tpl.html</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@extend ('layout') @startInsert('confession-content')</span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"@u"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">class</span>=<span class="string">"my-2"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group row"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"title"</span> <span class="attr">class</span>=<span class="string">"col-sm-2 col-form-label"</span>&gt;</span>&#123;= 标题 &#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-10"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">id</span>=<span class="string">"title"</span> <span class="attr">name</span>=<span class="string">"title"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group row"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"description"</span> <span class="attr">class</span>=<span class="string">"col-sm-2 col-form-label"</span>&gt;</span>&#123;= 具体内容 &#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-10"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">name</span>=<span class="string">"content"</span> <span class="attr">id</span>=<span class="string">"description"</span> <span class="attr">rows</span>=<span class="string">"3"</span>&gt;</span> <span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group row"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-2"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">class</span>=<span class="string">"btn btn-info mb-2"</span> <span class="attr">name</span>=<span class="string">"action"</span> <span class="attr">value</span>=<span class="string">"publish"</span>&gt;</span>&#123;= 发布 &#125;<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"checkbox col"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"anonymous"</span> <span class="attr">name</span>=<span class="string">"anonymous"</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">value</span>=<span class="string">"true"</span>&gt;</span> &#123;= 匿名发表 &#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">@endInsert</span><br></pre></td></tr></table></figure><h4 id="config"><a href="#config" class="headerlink" title="config"></a>config</h4><h5 id="api"><a href="#api" class="headerlink" title="api"></a>api</h5><p><code>mapper.yml</code></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">v1.0:</span></span><br><span class="line"><span class="attr">  confession-wall:</span> <span class="string">dxkite.confession.wall.provider.ConfessionProvider</span></span><br></pre></td></tr></table></figure><p><strong>关于发布匿名表白及使用线路2进行匿名表白这里就略了，可直接会长的文章</strong><br><a href="https://dxkite.cn/2018/08/23/suda-confession-wall-simple-action/" target="_blank" rel="noopener">https://dxkite.cn/2018/08/23/suda-confession-wall-simple-action/</a></p><h3 id="列出表白"><a href="#列出表白" class="headerlink" title="列出表白"></a>列出表白</h3><h4 id="table-1"><a href="#table-1" class="headerlink" title="table"></a>table</h4><h5 id="ConfessionController-php-1"><a href="#ConfessionController-php-1" class="headerlink" title="ConfessionController.php"></a>ConfessionController.php</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">dxkite</span>\<span class="title">confession</span>\<span class="title">wall</span>\<span class="title">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">dxkite</span>\<span class="title">confession</span>\<span class="title">wall</span>\<span class="title">table</span>\<span class="title">ConfessionTable</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">dxkite</span>\<span class="title">support</span>\<span class="title">view</span>\<span class="title">TablePager</span>; <span class="comment">// 引入分页函数类</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理表白</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConfessionController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $table;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;table = <span class="keyword">new</span> ConfessionTable;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加表白帖</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $title</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $content</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> boolean $anonymous</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> integer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">(string $title, string $content, bool $anonymous=true)</span>: <span class="title">int</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;table-&gt;insert([</span><br><span class="line">            <span class="string">'user'</span> =&gt; get_user_id(),</span><br><span class="line">            <span class="string">'title'</span> =&gt; $title ,</span><br><span class="line">            <span class="string">'content'</span> =&gt; $content,</span><br><span class="line">            <span class="string">'anonymous'</span> =&gt; $anonymous ? <span class="number">1</span> :<span class="number">0</span>,</span><br><span class="line">            <span class="string">'time'</span> =&gt; time(),</span><br><span class="line">            <span class="string">'ip'</span> =&gt; request()-&gt;ip(),</span><br><span class="line">            <span class="string">'status'</span> =&gt; ConfessionTable::STATUS_NORMAL,</span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">list</span><span class="params">(?int $page, int $row = <span class="number">10</span>)</span>:?<span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//  列出表元素，当状态为：ConfessionTable::STATUS_NORMAL 的时候</span></span><br><span class="line">        <span class="keyword">return</span> TablePager::listWhere(<span class="keyword">$this</span>-&gt;table, [<span class="string">'status'</span> =&gt; ConfessionTable::STATUS_NORMAL], [], $page, $row);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="provider-1"><a href="#provider-1" class="headerlink" title="provider"></a>provider</h4><h5 id="ConfessionProvider-php-1"><a href="#ConfessionProvider-php-1" class="headerlink" title="ConfessionProvider.php"></a>ConfessionProvider.php</h5><p><strong>添加列出函数</strong></p><p>1.方案一<br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">list</span><span class="params">(?int $page, int $row = <span class="number">10</span>)</span>:?<span class="title">array</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $pageData = <span class="keyword">$this</span>-&gt;controller-&gt;list($page, $row);</span><br><span class="line">    $pageRows = $pageData[<span class="string">'rows'</span>]; <span class="comment">// 获取到数据字段</span></span><br><span class="line">    <span class="keyword">foreach</span> ($pageRows <span class="keyword">as</span> $index =&gt; $pageRow ) &#123;</span><br><span class="line">        <span class="comment">// 表示匿名状态</span></span><br><span class="line">        <span class="keyword">if</span> ($pageRow[<span class="string">'anonymous'</span>] == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// 清理user的信息</span></span><br><span class="line">            $pageRow[<span class="string">'user'</span>] = <span class="number">0</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// 根据ID获取信息</span></span><br><span class="line">            $pageRow[<span class="string">'user'</span>] = get_user_public_info($pageRow[<span class="string">'user'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 去除IP信息</span></span><br><span class="line">        <span class="keyword">unset</span>($pageRow[<span class="string">'ip'</span>]);</span><br><span class="line">        <span class="comment">// 替换原来的列</span></span><br><span class="line">        $pageRows[$index] = $pageRow;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 放回原来的字段</span></span><br><span class="line">    $pageData[<span class="string">'rows'</span>] = $pageRows;</span><br><span class="line">    <span class="keyword">return</span> $pageData;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>2.方案二<br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">list</span><span class="params">(?int $page, int $row = <span class="number">10</span>)</span>:?<span class="title">array</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $pageData = <span class="keyword">$this</span>-&gt;controller-&gt;list($page, $row);</span><br><span class="line">    $pageRows = $pageData[<span class="string">'rows'</span>]; <span class="comment">// 获取到数据字段</span></span><br><span class="line">    <span class="comment">// 检测到需要处理的用户ID</span></span><br><span class="line">    $userIdMap = [];</span><br><span class="line">    <span class="keyword">foreach</span> ($pageRows <span class="keyword">as</span> $index =&gt; $pageRow) &#123;</span><br><span class="line">        <span class="comment">// 表示匿名状态</span></span><br><span class="line">        <span class="keyword">if</span> ($pageRow[<span class="string">'anonymous'</span>] == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// 清理user的信息</span></span><br><span class="line">            $pageRow[<span class="string">'user'</span>] = <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 记录ID信息</span></span><br><span class="line">            <span class="comment">// ID =&gt; 索引</span></span><br><span class="line">            $userIdMap[$pageRow[<span class="string">'user'</span>]]=$index;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 去除IP信息</span></span><br><span class="line">        <span class="keyword">unset</span>($pageRow[<span class="string">'ip'</span>]);</span><br><span class="line">        <span class="comment">// 替换原来的列</span></span><br><span class="line">        $pageRows[$index] = $pageRow;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取所有用户信息</span></span><br><span class="line">    $userInfos = get_user_public_info_array(array_keys($userIdMap));</span><br><span class="line">    <span class="comment">// 返回到数据列</span></span><br><span class="line">    <span class="keyword">foreach</span> ($userInfos <span class="keyword">as</span> $id =&gt; $data) &#123;</span><br><span class="line">        <span class="comment">// $userIdMap[$id] == index</span></span><br><span class="line">        $pageRows[$userIdMap[$id]][<span class="string">'user'</span>]=$data;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 放回原来的字段</span></span><br><span class="line">    $pageData[<span class="string">'rows'</span>] = $pageRows;</span><br><span class="line">    <span class="keyword">return</span> $pageData;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="表白管理"><a href="#表白管理" class="headerlink" title="表白管理"></a>表白管理</h3><h4 id="config-1"><a href="#config-1" class="headerlink" title="config"></a>config</h4><p><code>permissions.yml</code></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">confession-wall:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">表白墙权限管理</span></span><br><span class="line"><span class="attr">  childs:</span></span><br><span class="line"><span class="attr">    view:</span> <span class="string">查看表白列表</span></span><br><span class="line"><span class="attr">    status:</span> <span class="string">编辑列表状态</span></span><br><span class="line"><span class="attr">    edit:</span> <span class="string">编辑表白</span></span><br><span class="line"><span class="attr">    delete:</span> <span class="string">删除表白</span></span><br></pre></td></tr></table></figure><p><img src="/2018/08/12/Suda-confession-wall/5.png" alt="5"></p><h5 id="api-1"><a href="#api-1" class="headerlink" title="api"></a>api</h5><p><code>mapper.yml</code></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">v1.0:</span></span><br><span class="line"><span class="attr">  confession-wall:</span> <span class="string">dxkite.confession.wall.provider.ConfessionProvider</span></span><br><span class="line"><span class="attr">  confession-wall-setting:</span> <span class="string">dxkite.confession.wall.provider.ConfessionSettingProvider</span></span><br></pre></td></tr></table></figure><h4 id="provider-2"><a href="#provider-2" class="headerlink" title="provider"></a>provider</h4><h5 id="ConfessionSettingProvider-php"><a href="#ConfessionSettingProvider-php" class="headerlink" title="ConfessionSettingProvider.php"></a>ConfessionSettingProvider.php</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">dxkite</span>\<span class="title">confession</span>\<span class="title">wall</span>\<span class="title">provider</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">dxkite</span>\<span class="title">confession</span>\<span class="title">wall</span>\<span class="title">controller</span>\<span class="title">ConfessionController</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 管理表白</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConfessionSettingProvider</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $controller;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;controller = <span class="keyword">new</span> ConfessionController;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 列出表白墙列表</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@acl</span> confession-wall.view</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> integer|null $page</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> integer $row</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array|null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">list</span><span class="params">(?int $page, int $row = <span class="number">10</span>)</span>:?<span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $pageData = <span class="keyword">$this</span>-&gt;controller-&gt;list($page, $row);</span><br><span class="line">        $pageRows = $pageData[<span class="string">'rows'</span>]; <span class="comment">// 获取到数据字段</span></span><br><span class="line">        <span class="comment">// 检测到需要处理的用户ID</span></span><br><span class="line">        $userIdMap = [];</span><br><span class="line">        <span class="keyword">foreach</span> ($pageRows <span class="keyword">as</span> $index =&gt; $pageRow) &#123;</span><br><span class="line">            $userIdMap[$pageRow[<span class="string">'user'</span>]][]=$index;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取所有用户信息</span></span><br><span class="line">        $userInfos = get_user_public_info_array(array_keys($userIdMap));</span><br><span class="line">        <span class="comment">// 返回到数据列</span></span><br><span class="line">        <span class="keyword">foreach</span> ($userInfos <span class="keyword">as</span> $id =&gt; $data) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> ($userIdMap[$id] <span class="keyword">as</span> $index) &#123;</span><br><span class="line">                $pageRows[$index][<span class="string">'user'</span>]=$data;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 放回原来的字段</span></span><br><span class="line">        $pageData[<span class="string">'rows'</span>] = $pageRows;</span><br><span class="line">        <span class="keyword">return</span> $pageData;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可能你会缺少这个<code>use dxkite\confession\wall\table\ConfessionTable;</code></p><p><strong>有关添加权限角色与列出等操作，请移步会长文章</strong></p><p><a href="https://dxkite.cn/2018/08/25/suda-confession-wall-setting/" target="_blank" rel="noopener">https://dxkite.cn/2018/08/25/suda-confession-wall-setting/</a></p><h3 id="编辑删除"><a href="#编辑删除" class="headerlink" title="编辑删除"></a>编辑删除</h3><h4 id="provider-3"><a href="#provider-3" class="headerlink" title="provider"></a>provider</h4><h5 id="ConfessionSettingProvider-php-1"><a href="#ConfessionSettingProvider-php-1" class="headerlink" title="ConfessionSettingProvider.php"></a>ConfessionSettingProvider.php</h5><p><strong>添加编辑函数</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 编辑内容</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@acl</span> confession-wall.edit</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> integer $id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array $value</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> boolean</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">edit</span><span class="params">(int $id, array $value)</span>:<span class="title">bool</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $table = <span class="keyword">new</span> ConfessionTable;</span><br><span class="line">    <span class="keyword">if</span> (array_key_exists(<span class="string">'title'</span>, $value)) &#123;</span><br><span class="line">        $sets[<span class="string">'title'</span>]=$value[<span class="string">'title'</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (array_key_exists(<span class="string">'content'</span>, $value)) &#123;</span><br><span class="line">        $sets[<span class="string">'content'</span>]=$value[<span class="string">'content'</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $table-&gt;updateByPrimaryKey($id,$sets) &gt; <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>添加编辑函数</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除内容</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@acl</span> confession-wall.delete</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> integer $id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> boolean</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delete</span><span class="params">(int $id)</span>:<span class="title">bool</span> </span>&#123;</span><br><span class="line">    $table = <span class="keyword">new</span> ConfessionTable;</span><br><span class="line">    <span class="keyword">return</span> $table-&gt;updateByPrimaryKey($id,[<span class="string">'status'</span> =&gt; ConfessionTable::STATUS_DELETE ]) &gt; <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>操作部分省略，移步文章</strong><br><a href="https://dxkite.cn/2018/08/26/suda-confession-wall-setting-edit-delete/" target="_blank" rel="noopener">https://dxkite.cn/2018/08/26/suda-confession-wall-setting-edit-delete/</a></p><h3 id="评论功能"><a href="#评论功能" class="headerlink" title="评论功能"></a>评论功能</h3><ol><li><p>预览一下<br><img src="/2018/08/12/Suda-confession-wall/7.png" alt="7"></p></li><li><p><code>module.json</code> 注意写一下</p></li><li><p><code>app/mainifast.yml</code></p><blockquote><ol><li>启动相应模块 support &amp;&amp; 评论</li></ol></blockquote></li></ol><h4 id="table-2"><a href="#table-2" class="headerlink" title="table"></a>table</h4><h5 id="CommentTable-php"><a href="#CommentTable-php" class="headerlink" title="CommentTable.php"></a>CommentTable.php</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">dxkite</span>\<span class="title">comments</span>\<span class="title">table</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 评论</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommentTable</span> <span class="keyword">extends</span> \<span class="title">suda</span>\<span class="title">archive</span>\<span class="title">Table</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> CONTENT_TYPE = <span class="string">'markdown'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> STATUS_DELETE = <span class="number">0</span>;  <span class="comment">// 删除状态</span></span><br><span class="line">    <span class="keyword">const</span> STATUS_NORMAL = <span class="number">1</span>;  <span class="comment">// 正常状态</span></span><br><span class="line">    <span class="keyword">const</span> STATUS_DRAFT = <span class="number">2</span>;  <span class="comment">// 草稿状态</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string $subfix=null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">parent</span>::__construct(<span class="string">'comment'</span>. <span class="keyword">self</span>::parseSubfix($subfix));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseSubfix</span><span class="params">(?string $subfix)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!is_null($subfix)) &#123;</span><br><span class="line">            $subfix = <span class="string">'_'</span>.$subfix;</span><br><span class="line">            <span class="keyword">return</span> preg_replace(<span class="string">'/[^\w]+/'</span>,<span class="string">'_'</span>,$subfix);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onBuildCreator</span><span class="params">($table)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $table-&gt;fields(</span><br><span class="line">            $table-&gt;field(<span class="string">'id'</span>, <span class="string">'bigint'</span>, <span class="number">20</span>)-&gt;primary()-&gt;unsigned()-&gt;auto(),</span><br><span class="line">            $table-&gt;field(<span class="string">'user'</span>, <span class="string">'bigint'</span>, <span class="number">20</span>)-&gt;key()-&gt;comment(<span class="string">'发布者'</span>),</span><br><span class="line">            $table-&gt;field(<span class="string">'target'</span>, <span class="string">'bigint'</span>, <span class="number">20</span>)-&gt;key()-&gt;comment(<span class="string">'目标'</span>),</span><br><span class="line">            $table-&gt;field(<span class="string">'content'</span>, <span class="string">'text'</span>)-&gt;comment(<span class="string">"文字内容"</span>),</span><br><span class="line">            $table-&gt;field(<span class="string">'time'</span>, <span class="string">'int'</span>, <span class="number">11</span>)-&gt;key()-&gt;unsigned()-&gt;comment(<span class="string">'发表时间'</span>),</span><br><span class="line">            $table-&gt;field(<span class="string">'ip'</span>, <span class="string">'varchar'</span>, <span class="number">32</span>)-&gt;comment(<span class="string">'发布IP'</span>),</span><br><span class="line">            $table-&gt;field(<span class="string">'status'</span>, <span class="string">'int'</span>, <span class="number">11</span>)-&gt;key()-&gt;unsigned()-&gt;default(<span class="keyword">self</span>::STATUS_DRAFT)-&gt;comment(<span class="string">'状态'</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用Markdown 对内容进行默认编码</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $content</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">_inputContentField</span><span class="params">(string $content)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> content_pack($content, <span class="keyword">self</span>::CONTENT_TYPE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将内容解码成HTML格式</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $content</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">_outputContentField</span><span class="params">(string $content)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 解码成对象</span></span><br><span class="line">        <span class="keyword">if</span> ($object = content_unpack($content)) &#123;</span><br><span class="line">            <span class="keyword">return</span> $object;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 未设置解码则按text编码</span></span><br><span class="line">        <span class="keyword">return</span> content_create($content, <span class="string">'text'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="SubCommentTable-php"><a href="#SubCommentTable-php" class="headerlink" title="SubCommentTable.php"></a>SubCommentTable.php</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">dxkite</span>\<span class="title">comments</span>\<span class="title">table</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 子评论</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubCommentTable</span> <span class="keyword">extends</span> <span class="title">CommentTable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string $subfix =null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">parent</span>::__construct(<span class="string">'sub'</span> .<span class="keyword">self</span>::parseSubfix($subfix));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onBuildCreator</span><span class="params">($table)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $table = <span class="keyword">parent</span>::onBuildCreator($table);</span><br><span class="line">        <span class="keyword">return</span> $table-&gt;fields(</span><br><span class="line">            $table-&gt;field(<span class="string">'parent'</span>, <span class="string">'bigint'</span>, <span class="number">20</span>)-&gt;key()-&gt;comment(<span class="string">'父评论'</span>),</span><br><span class="line">            $table-&gt;field(<span class="string">'reply'</span>, <span class="string">'bigint'</span>, <span class="number">20</span>)-&gt;key()-&gt;comment(<span class="string">'回复'</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="controller-1"><a href="#controller-1" class="headerlink" title="controller"></a>controller</h4><h5 id="CommentController-php"><a href="#CommentController-php" class="headerlink" title="CommentController.php"></a>CommentController.php</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">dxkite</span>\<span class="title">comments</span>\<span class="title">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">dxkite</span>\<span class="title">comments</span>\<span class="title">table</span>\<span class="title">CommentTable</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">dxkite</span>\<span class="title">comments</span>\<span class="title">table</span>\<span class="title">SubCommentTable</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">dxkite</span>\<span class="title">support</span>\<span class="title">view</span>\<span class="title">TablePager</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 评论</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommentController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $commentTable;</span><br><span class="line">    <span class="keyword">protected</span> $subCommentTable;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string $name = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;commentTable= <span class="keyword">new</span> CommentTable($name);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;subCommentTable= <span class="keyword">new</span> SubCommentTable($name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 评论</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> integer $target</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $content</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> integer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">(int $target, string $content)</span>:<span class="title">int</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $user =  get_user_id();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;commentTable-&gt;insert([</span><br><span class="line">            <span class="string">'user'</span> =&gt; $user,</span><br><span class="line">            <span class="string">'target'</span> =&gt; $target,</span><br><span class="line">            <span class="string">'content'</span> =&gt; $content,</span><br><span class="line">            <span class="string">'time'</span> =&gt; time(),</span><br><span class="line">            <span class="string">'ip'</span> =&gt; request()-&gt;ip(),</span><br><span class="line">            <span class="string">'status'</span> =&gt;  CommentTable::STATUS_NORMAL,</span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 评论评论</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> integer $comment</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $content</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> integer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">comment</span><span class="params">(int $comment, string $content)</span>:<span class="title">int</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $user =  get_user_id();</span><br><span class="line">        <span class="keyword">if</span> ($parent = <span class="keyword">$this</span>-&gt;commentTable-&gt;getByPrimaryKey($comment)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;subCommentTable-&gt;insert([</span><br><span class="line">                <span class="string">'user'</span> =&gt; $user,</span><br><span class="line">                <span class="string">'target'</span> =&gt; $parent[<span class="string">'target'</span>],</span><br><span class="line">                <span class="string">'content'</span> =&gt; $content,</span><br><span class="line">                <span class="string">'parent'</span>=&gt; $comment,</span><br><span class="line">                <span class="string">'time'</span> =&gt; time(),</span><br><span class="line">                <span class="string">'ip'</span> =&gt; request()-&gt;ip(),</span><br><span class="line">                <span class="string">'status'</span> =&gt;  CommentTable::STATUS_NORMAL,</span><br><span class="line">            ]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除评论</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> integer $comment</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> boolean $sub</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> boolean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delete</span><span class="params">(int $comment, bool $sub = false)</span>:<span class="title">bool</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $user =  get_user_id();</span><br><span class="line">        $table = $sub ? <span class="keyword">$this</span>-&gt;subCommentTable : <span class="keyword">$this</span>-&gt;commentTable;</span><br><span class="line">        <span class="keyword">if</span> ($that = $table-&gt;getByPrimaryKey($comment)) &#123;</span><br><span class="line">            <span class="comment">// 只有自己能够删除</span></span><br><span class="line">            <span class="keyword">if</span> ($that[<span class="string">'user'</span>] == $user) &#123;</span><br><span class="line">                <span class="keyword">return</span> $table-&gt;updateByPrimaryKey($that[<span class="string">'id'</span>], [</span><br><span class="line">                    <span class="string">'status'</span> =&gt;  CommentTable::STATUS_DELETE,</span><br><span class="line">                ]) &gt; <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 回复子评论</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> integer $subcommet</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $content</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> integer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">reply</span><span class="params">(int $subcommet, string $content)</span>:<span class="title">int</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $user =  get_user_id();</span><br><span class="line">        <span class="keyword">if</span> ($parent = <span class="keyword">$this</span>-&gt;subCommentTable-&gt;getByPrimaryKey($subcommet)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;subCommentTable-&gt;insert([</span><br><span class="line">                <span class="string">'user'</span> =&gt; $user,</span><br><span class="line">                <span class="string">'target'</span> =&gt; $parent[<span class="string">'target'</span>],</span><br><span class="line">                <span class="string">'reply'</span> =&gt; $parent[<span class="string">'user'</span>],</span><br><span class="line">                <span class="string">'content'</span> =&gt; $content,</span><br><span class="line">                <span class="string">'parent'</span>=&gt; $parent[<span class="string">'parent'</span>],</span><br><span class="line">                <span class="string">'time'</span> =&gt; time(),</span><br><span class="line">                <span class="string">'ip'</span> =&gt; request()-&gt;ip(),</span><br><span class="line">                <span class="string">'status'</span> =&gt;  CommentTable::STATUS_NORMAL,</span><br><span class="line">            ]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取目标评论</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> integer $target</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> integer|null $page</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> integer $row</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array|null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getComment</span><span class="params">(int $target, ?int $page, int $row = <span class="number">10</span>)</span>:?<span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> TablePager::listWhere(<span class="keyword">$this</span>-&gt;commentTable, [<span class="string">'status'</span> =&gt; CommentTable::STATUS_NORMAL], [], $page, $row);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取评论的评论</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> integer $comment</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> integer|null $page</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> integer $row</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array|null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getSubComment</span><span class="params">(int $comment, ?int $page, int $row = <span class="number">10</span>)</span>:?<span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> TablePager::listWhere(<span class="keyword">$this</span>-&gt;subCommentTable, [<span class="string">'status'</span> =&gt; CommentTable::STATUS_NORMAL], [], $page, $row);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="provider-4"><a href="#provider-4" class="headerlink" title="provider"></a>provider</h4><h5 id="CommentProvider-php"><a href="#CommentProvider-php" class="headerlink" title="CommentProvider.php"></a>CommentProvider.php</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">dxkite</span>\<span class="title">comments</span>\<span class="title">provider</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">dxkite</span>\<span class="title">comments</span>\<span class="title">controller</span>\<span class="title">CommentController</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 评论</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommentProvider</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $name = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">protected</span> $commentTable;</span><br><span class="line">    <span class="keyword">protected</span> $subCommentTable;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string $name = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;controller =  <span class="keyword">new</span> CommentController($name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 评论</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> integer $target</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $content</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> integer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">(int $target, string $content)</span>:<span class="title">int</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;controller-&gt;add($target, $content);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 评论评论</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> integer $comment</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $content</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> integer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">comment</span><span class="params">(int $comment, string $content)</span>:<span class="title">int</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;controller-&gt;comment($comment, $content);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 回复子评论</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> integer $subcommet</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $content</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> integer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">reply</span><span class="params">(int $subcommet, string $content)</span>:<span class="title">int</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;controller-&gt;reply($subcommet, $content);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取目标评论</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> integer $target</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> integer|null $page</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> integer $row</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array|null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getComment</span><span class="params">(int $target, ?int $page=null, int $row=<span class="number">10</span>)</span>:?<span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $comments = <span class="keyword">$this</span>-&gt;controller-&gt;getComment($target, $page, $row);</span><br><span class="line">        $rows = $comments[<span class="string">'rows'</span>];</span><br><span class="line">        $ids = [];</span><br><span class="line">        <span class="keyword">foreach</span> ($rows <span class="keyword">as</span> $index =&gt; $row) &#123;</span><br><span class="line">            $ids[] = $row[<span class="string">'user'</span>];</span><br><span class="line">            <span class="keyword">unset</span>($row[<span class="string">'ip'</span>]);</span><br><span class="line">            $rows[$index] = $row;</span><br><span class="line">        &#125;</span><br><span class="line">        $userInfos = get_user_public_info_array($ids);</span><br><span class="line">        <span class="keyword">foreach</span> ($rows <span class="keyword">as</span> $index =&gt; $row) &#123;</span><br><span class="line">           $rows[$index][<span class="string">'user'</span>] = $userInfos[$row[<span class="string">'user'</span>]] ?? $row[<span class="string">'user'</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        $comments[<span class="string">'rows'</span>] = $rows;</span><br><span class="line">        <span class="keyword">return</span> $comments;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取评论的评论</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> integer $comment</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> integer|null $page</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> integer $row</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array|null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getSubComment</span><span class="params">(int $comment, ?int $page=null, int $row=<span class="number">10</span>)</span>:?<span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $comments = <span class="keyword">$this</span>-&gt;controller-&gt;getSubComment($comment, $page, $row);</span><br><span class="line">        $rows = $comments[<span class="string">'rows'</span>];</span><br><span class="line">        $ids = [];</span><br><span class="line">        <span class="keyword">foreach</span> ($rows <span class="keyword">as</span> $index =&gt; $row) &#123;</span><br><span class="line">            $ids[] = $row[<span class="string">'user'</span>];</span><br><span class="line">            <span class="keyword">unset</span>($row[<span class="string">'ip'</span>]);</span><br><span class="line">            $rows[$index] = $row;</span><br><span class="line">        &#125;</span><br><span class="line">        $userInfos = get_user_public_info_array($ids);</span><br><span class="line">        <span class="keyword">foreach</span> ($rows <span class="keyword">as</span> $index =&gt; $row) &#123;</span><br><span class="line">            $rows[$index][<span class="string">'user'</span>] = $userInfos[$row[<span class="string">'user'</span>]] ?? $row[<span class="string">'user'</span>];</span><br><span class="line">            $rows[$index][<span class="string">'reply'</span>] = $userInfos[$row[<span class="string">'reply'</span>]] ?? $row[<span class="string">'reply'</span>];</span><br><span class="line">         &#125;</span><br><span class="line">        $comments[<span class="string">'rows'</span>] = $rows;</span><br><span class="line">        <span class="keyword">return</span> $comments;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除特定评论</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> integer $comment</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> boolean $sub</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> boolean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delete</span><span class="params">(int $comment, bool $sub = false)</span>:<span class="title">bool</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;controller-&gt;delete($comment, $sub);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="config-confession-wall"><a href="#config-confession-wall" class="headerlink" title="config (confession.wall)"></a>config (confession.wall)</h4><h5 id="api-2"><a href="#api-2" class="headerlink" title="api"></a>api</h5><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">v1.0:</span></span><br><span class="line"><span class="attr">  confession-wall:</span> <span class="string">dxkite.confession.wall.provider.ConfessionProvider</span></span><br><span class="line"><span class="attr">  confession-wall-comment:</span> <span class="string">dxkite.comments.provider.CommentProvider(confession-wall)</span></span><br><span class="line"><span class="attr">  confession-wall-setting:</span> <span class="string">dxkite.confession.wall.provider.ConfessionSettingProvider</span></span><br></pre></td></tr></table></figure><p><strong>不逼逼了，直接给链接</strong></p><p><a href="https://dxkite.cn/2018/08/27/suda-comment/" target="_blank" rel="noopener">https://dxkite.cn/2018/08/27/suda-comment/</a></p><h3 id="附件功能"><a href="#附件功能" class="headerlink" title="附件功能"></a>附件功能</h3><ol><li><p>预览一下<br><img src="/2018/08/12/Suda-confession-wall/8.png" alt="8"></p></li><li><p><code>module.json</code> 注意写一下</p></li><li><p><code>app/mainifast.yml</code></p><blockquote><ol><li>启动相应模块</li></ol></blockquote></li></ol><h4 id="table-3"><a href="#table-3" class="headerlink" title="table"></a>table</h4><h5 id="CommentTable-php-1"><a href="#CommentTable-php-1" class="headerlink" title="CommentTable.php"></a>CommentTable.php</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">dxkite</span>\<span class="title">attachments</span>\<span class="title">table</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">suda</span>\<span class="title">tool</span>\<span class="title">Command</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">suda</span>\<span class="title">archive</span>\<span class="title">Table</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 附件表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AttachmentTable</span> <span class="keyword">extends</span> <span class="title">Table</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $target;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string $target=null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 实例化一个字符串到类</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;target = Command::newClassInstance($target);</span><br><span class="line">        $perfix = <span class="keyword">self</span>::parsePerfix(<span class="keyword">$this</span>-&gt;target-&gt;getTableName());</span><br><span class="line">        <span class="keyword">parent</span>::__construct($perfix.<span class="string">'attachments'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getTargetTable</span><span class="params">()</span>:<span class="title">Table</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parsePerfix</span><span class="params">(?string $fix)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!is_null($fix)) &#123;</span><br><span class="line">            $fix = $fix.<span class="string">'_'</span>;</span><br><span class="line">            <span class="keyword">return</span> ltrim(preg_replace(<span class="string">'/[^\w]+/'</span>, <span class="string">'_'</span>, $fix), <span class="string">'_'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onBuildCreator</span><span class="params">($table)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $table-&gt;fields(</span><br><span class="line">            $table-&gt;field(<span class="string">'id'</span>, <span class="string">'bigint'</span>, <span class="number">20</span>)-&gt;primary()-&gt;unsigned()-&gt;auto(),</span><br><span class="line">            $table-&gt;field(<span class="string">'target'</span>, <span class="string">'bigint'</span>, <span class="number">20</span>)-&gt;unsigned()-&gt;comment(<span class="string">'目标内容'</span>),</span><br><span class="line">            $table-&gt;field(<span class="string">'attachment'</span>, <span class="string">'bigint'</span>, <span class="number">20</span>)-&gt;unsigned()-&gt;comment(<span class="string">'附件ID'</span>),</span><br><span class="line">            $table-&gt;field(<span class="string">'hash'</span>, <span class="string">'varchar'</span>, <span class="number">32</span>)-&gt;comment(<span class="string">'附件Hash'</span>),</span><br><span class="line">            $table-&gt;field(<span class="string">'time'</span>, <span class="string">'int'</span>, <span class="number">11</span>)-&gt;key()-&gt;unsigned()-&gt;comment(<span class="string">'添加时间'</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="controller-2"><a href="#controller-2" class="headerlink" title="controller"></a>controller</h4><h5 id="AttachmentController-php"><a href="#AttachmentController-php" class="headerlink" title="AttachmentController.php"></a>AttachmentController.php</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">dxkite</span>\<span class="title">attachments</span>\<span class="title">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">suda</span>\<span class="title">core</span>\<span class="title">Query</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">suda</span>\<span class="title">exception</span>\<span class="title">SQLException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">dxkite</span>\<span class="title">support</span>\<span class="title">file</span>\<span class="title">File</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">dxkite</span>\<span class="title">support</span>\<span class="title">file</span>\<span class="title">Media</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">dxkite</span>\<span class="title">attachments</span>\<span class="title">table</span>\<span class="title">AttachmentTable</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 附件控制器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AttachmentController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $table;</span><br><span class="line">    <span class="keyword">protected</span> $target;</span><br><span class="line">    <span class="keyword">protected</span> $userField;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string $target, string $userField = <span class="string">'user'</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">$this</span>-&gt;table=<span class="keyword">new</span> AttachmentTable($target);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;target = <span class="keyword">$this</span>-&gt;table-&gt;getTargetTable();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;userField = $userField;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">(int $target, File $attachment)</span>:<span class="title">bool</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($targetData = <span class="keyword">$this</span>-&gt;target-&gt;getByPrimaryKey($target)) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($targetData[<span class="keyword">$this</span>-&gt;userField] == get_user_id()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;table-&gt;select(<span class="string">'*'</span>, [<span class="string">'hash'</span>=&gt;$attachment-&gt;getMd5(),<span class="string">'target'</span>=&gt;$target])-&gt;fetch()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    $file = Media::save($attachment);</span><br><span class="line">                    <span class="keyword">if</span> (!$file) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;table-&gt;insert([</span><br><span class="line">                        <span class="string">'time'</span>=&gt;time(),</span><br><span class="line">                        <span class="string">'target'</span>=&gt; $target,</span><br><span class="line">                        <span class="string">'attachment'</span> =&gt; $file-&gt;getId(),</span><br><span class="line">                        <span class="string">'hash'</span> =&gt; $attachment-&gt;getMd5(),</span><br><span class="line">                    ]) &gt; <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAttachments</span><span class="params">(int $target)</span>:?<span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($images = <span class="keyword">$this</span>-&gt;table-&gt;select(<span class="string">'*'</span>, [<span class="string">'target'</span>=&gt;$target])-&gt;fetchAll()) &#123;</span><br><span class="line">            <span class="keyword">return</span> $images;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delete</span><span class="params">(int $attachmentId)</span>:<span class="title">bool</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($fetchData = <span class="keyword">$this</span>-&gt;table-&gt;select([<span class="string">'attachment'</span>,<span class="string">'target'</span>], [<span class="string">'id'</span>=&gt;$attachmentId])-&gt;fetch()) &#123;</span><br><span class="line">            <span class="keyword">list</span>(<span class="string">'target'</span>=&gt;$target,<span class="string">'attachment'</span> =&gt; $attachment) = $fetchData;</span><br><span class="line">            <span class="keyword">if</span> ($targetData = <span class="keyword">$this</span>-&gt;target-&gt;getByPrimaryKey($target)) &#123;</span><br><span class="line">                <span class="keyword">if</span> ($targetData[<span class="keyword">$this</span>-&gt;userField] == get_user_id()) &#123;</span><br><span class="line">                    Media::delete($attachment);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;table-&gt;delete([<span class="string">'id'</span>=&gt;$attachmentId]) &gt; <span class="number">0</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="provider-5"><a href="#provider-5" class="headerlink" title="provider"></a>provider</h4><h5 id="AttachmentProvider-php"><a href="#AttachmentProvider-php" class="headerlink" title="AttachmentProvider.php"></a>AttachmentProvider.php</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">dxkite</span>\<span class="title">attachments</span>\<span class="title">provider</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">dxkite</span>\<span class="title">attachments</span>\<span class="title">controller</span>\<span class="title">AttachmentController</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">dxkite</span>\<span class="title">support</span>\<span class="title">file</span>\<span class="title">File</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 附件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AttachmentProvider</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $controller;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string $name = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;controller =  <span class="keyword">new</span> AttachmentController($name);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">(int $target, File $attachment)</span>:<span class="title">bool</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;controller-&gt;add($target, $attachment);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAttachments</span><span class="params">(int $target)</span>:?<span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;controller-&gt;getAttachments($target);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delete</span><span class="params">(int $attachmentId)</span>:<span class="title">bool</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;controller-&gt;delete($attachmentId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="config-confession-wall-1"><a href="#config-confession-wall-1" class="headerlink" title="config (confession.wall)"></a>config (confession.wall)</h4><h5 id="api-3"><a href="#api-3" class="headerlink" title="api"></a>api</h5><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">v1.0:</span></span><br><span class="line"><span class="attr">  confession-wall:</span> <span class="string">dxkite.confession.wall.provider.ConfessionProvider</span></span><br><span class="line"><span class="attr">  confession-wall-comment:</span> <span class="string">dxkite.comments.provider.CommentProvider(confession-wall)</span></span><br><span class="line"><span class="attr">  confession-wall-attachment:</span> <span class="string">dxkite.attachments.provider.AttachmentProvider(dxkite.confession.wall.table.ConfessionTable)</span></span><br><span class="line"><span class="attr">  confession-wall-setting:</span> <span class="string">dxkite.confession.wall.provider.ConfessionSettingProvider</span></span><br></pre></td></tr></table></figure><p><strong>具体操作就…</strong></p><p><a href="https://dxkite.cn/2018/08/28/suda-attachments/" target="_blank" rel="noopener">https://dxkite.cn/2018/08/28/suda-attachments/</a></p><p>大概就是这样 基本的功能已经实现</p></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Suda/" rel="tag"><i class="fa fa-tag"></i> Suda</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2018/08/12/Suda-apartment-management-system/" rel="next" title="记一次suda框架之宿舍管理系统"><i class="fa fa-chevron-left"></i> 记一次suda框架之宿舍管理系统</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2018/08/13/STL-vector-function/" rel="prev" title="STL之Vector函数">STL之Vector函数<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div><div id="gitalk-container"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap"> 站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="MoBenw"><p class="site-author-name" itemprop="name">MoBenw</p><p class="site-description motion-element" itemprop="description">一只前往大佬路上的萌新</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">12</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">6</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">13</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/MoBenw" target="_blank" title="GitHub"><i class="fa fa-fw fa-gitHub"></i> GitHub</a></span><span class="links-of-author-item"><a href="http://wpa.qq.com/msgrd?v=3&uin=838922678&site=qq&menu=yes" target="_blank" title="QQ"><i class="fa fa-fw fa-qq"></i> QQ</a></span></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#所需模块"><span class="nav-number">1.</span> <span class="nav-text">所需模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装模块"><span class="nav-number">2.</span> <span class="nav-text">安装模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#基本配置-amp-amp-发布表白"><span class="nav-number">3.</span> <span class="nav-text">基本配置&amp;&amp;发布表白</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#table"><span class="nav-number">3.1.</span> <span class="nav-text">table</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ConfessionTable-php"><span class="nav-number">3.1.1.</span> <span class="nav-text">ConfessionTable.php</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#controller"><span class="nav-number">3.2.</span> <span class="nav-text">controller</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ConfessionController-php"><span class="nav-number">3.2.1.</span> <span class="nav-text">ConfessionController.php</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#provider"><span class="nav-number">3.3.</span> <span class="nav-text">provider</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ConfessionProvider-php"><span class="nav-number">3.3.1.</span> <span class="nav-text">ConfessionProvider.php</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#src"><span class="nav-number">3.4.</span> <span class="nav-text">src</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#IndexResponse-php"><span class="nav-number">3.4.1.</span> <span class="nav-text">IndexResponse.php</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PostResponse-php"><span class="nav-number">3.4.2.</span> <span class="nav-text">PostResponse.php</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#template"><span class="nav-number">3.5.</span> <span class="nav-text">template</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#index-tpl-html"><span class="nav-number">3.5.1.</span> <span class="nav-text">index.tpl.html</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#header-tpl-html"><span class="nav-number">3.5.2.</span> <span class="nav-text">header.tpl.html</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#layout-tpl-html"><span class="nav-number">3.5.3.</span> <span class="nav-text">layout.tpl.html</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#post-tpl-html"><span class="nav-number">3.5.4.</span> <span class="nav-text">post.tpl.html</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#config"><span class="nav-number">3.6.</span> <span class="nav-text">config</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#api"><span class="nav-number">3.6.1.</span> <span class="nav-text">api</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#列出表白"><span class="nav-number">4.</span> <span class="nav-text">列出表白</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#table-1"><span class="nav-number">4.1.</span> <span class="nav-text">table</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ConfessionController-php-1"><span class="nav-number">4.1.1.</span> <span class="nav-text">ConfessionController.php</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#provider-1"><span class="nav-number">4.2.</span> <span class="nav-text">provider</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ConfessionProvider-php-1"><span class="nav-number">4.2.1.</span> <span class="nav-text">ConfessionProvider.php</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#表白管理"><span class="nav-number">5.</span> <span class="nav-text">表白管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#config-1"><span class="nav-number">5.1.</span> <span class="nav-text">config</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#api-1"><span class="nav-number">5.1.1.</span> <span class="nav-text">api</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#provider-2"><span class="nav-number">5.2.</span> <span class="nav-text">provider</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ConfessionSettingProvider-php"><span class="nav-number">5.2.1.</span> <span class="nav-text">ConfessionSettingProvider.php</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编辑删除"><span class="nav-number">6.</span> <span class="nav-text">编辑删除</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#provider-3"><span class="nav-number">6.1.</span> <span class="nav-text">provider</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ConfessionSettingProvider-php-1"><span class="nav-number">6.1.1.</span> <span class="nav-text">ConfessionSettingProvider.php</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#评论功能"><span class="nav-number">7.</span> <span class="nav-text">评论功能</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#table-2"><span class="nav-number">7.1.</span> <span class="nav-text">table</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#CommentTable-php"><span class="nav-number">7.1.1.</span> <span class="nav-text">CommentTable.php</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SubCommentTable-php"><span class="nav-number">7.1.2.</span> <span class="nav-text">SubCommentTable.php</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#controller-1"><span class="nav-number">7.2.</span> <span class="nav-text">controller</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#CommentController-php"><span class="nav-number">7.2.1.</span> <span class="nav-text">CommentController.php</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#provider-4"><span class="nav-number">7.3.</span> <span class="nav-text">provider</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#CommentProvider-php"><span class="nav-number">7.3.1.</span> <span class="nav-text">CommentProvider.php</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#config-confession-wall"><span class="nav-number">7.4.</span> <span class="nav-text">config (confession.wall)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#api-2"><span class="nav-number">7.4.1.</span> <span class="nav-text">api</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#附件功能"><span class="nav-number">8.</span> <span class="nav-text">附件功能</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#table-3"><span class="nav-number">8.1.</span> <span class="nav-text">table</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#CommentTable-php-1"><span class="nav-number">8.1.1.</span> <span class="nav-text">CommentTable.php</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#controller-2"><span class="nav-number">8.2.</span> <span class="nav-text">controller</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#AttachmentController-php"><span class="nav-number">8.2.1.</span> <span class="nav-text">AttachmentController.php</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#provider-5"><span class="nav-number">8.3.</span> <span class="nav-text">provider</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#AttachmentProvider-php"><span class="nav-number">8.3.1.</span> <span class="nav-text">AttachmentProvider.php</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#config-confession-wall-1"><span class="nav-number">8.4.</span> <span class="nav-text">config (confession.wall)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#api-3"><span class="nav-number">8.4.1.</span> <span class="nav-text">api</span></a></li></ol></li></ol></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2018</span><span class="with-love" id="heart"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">MoBenw</span></div><div class="busuanzi-count"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="site-uv"><i class="fa fa-user"></i> 访问人数<span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span><span class="site-pv"><i class="fa fa-street-view"></i> 总访问量<span class="busuanzi-value" id="busuanzi_value_site_pv"></span> 次</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/fastclick/1.0.6/fastclick.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/jquery.lazyload/1.9.3/jquery.lazyload.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.ui.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script type="text/javascript">var gitalk=new Gitalk({clientID:"d1ce74892a5ce76e19ed",clientSecret:"fcfe33c24d569784237ca7daa2f4f487eabd8e8f",repo:"mobenw.github.io",owner:"MoBenw",admin:["MoBenw"],id:location.pathname,distractionFreeMode:"true"});gitalk.render("gitalk-container")</script><link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css"><script src="/lib/algolia-instant-search/instantsearch.min.js"></script><script src="/js/src/algolia-search.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/clicklove.js"></script></body></html>